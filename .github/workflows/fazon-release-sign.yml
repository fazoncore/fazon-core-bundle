name: FAZON Release Sign + Rekor Digest Audit

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

jobs:
  build-sign-verify:
    runs-on: ubuntu-latest
    env:
      COSIGN_VERSION: v3.0.4
      REKOR_URL: https://rekor.sigstore.dev

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare release artifact
        shell: bash
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist

          if [ -f "./release.zip" ]; then
            cp -f ./release.zip dist/release.zip
          else
            zip -r dist/release.zip . \
              -x ".git/*" ".github/*" "dist/*" "*.sigstore.json" "*.bundle" "*.sha256"
          fi

          sha256sum dist/release.zip | awk '{print $1}' > dist/release.zip.sha256

          TAG="${GITHUB_REF_NAME}"
          SHA="$(cat dist/release.zip.sha256)"
          TS="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          printf '{"name":"FAZON Release","tag":"%s","sha256":"%s","created_utc":"%s"}\n' "$TAG" "$SHA" "$TS" > dist/release.manifest.json

      - name: Install cosign (manual)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.local/bin"
          curl -fsSL -o "$HOME/.local/bin/cosign" "https://github.com/sigstore/cosign/releases/download/v3.0.4/cosign-linux-amd64"
          chmod +x "$HOME/.local/bin/cosign"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          cosign version

      - name: Cosign sign-blob (keyless) + bundle
        shell: bash
        run: |
          set -euo pipefail
          cosign version
          cosign sign-blob --yes --bundle dist/release.zip.sigstore.json dist/release.zip

      - name: Rekor digest audit (secondary verification)
        shell: bash
        run: |
          set -euo pipefail

          ARTIFACT="dist/release.zip"
          BUNDLE="dist/release.zip.sigstore.json"
          REKOR_URL="${REKOR_URL}"

          SHA256_LOCAL="$(sha256sum "$ARTIFACT" | awk '{print $1}')"

          UUIDS="$(jq -r '.. | objects | .uuid? // empty' "$BUNDLE" | sort -u)"
          LOGINDEX="$(jq -r '.. | objects | .logIndex? // empty' "$BUNDLE" | head -n1 || true)"
          if [ -z "${UUIDS:-}" ] && [ -n "${LOGINDEX:-}" ]; then
            Q="/tmp/rekor_by_index_${LOGINDEX}.json"
            curl -fsSL "${REKOR_URL}/api/v1/log/entries?logIndex=${LOGINDEX}" > "$Q"
            UUIDS="$(jq -r 'keys[]' "$Q" | head -n1 || true)"
          fi

          if [ -z "${UUIDS:-}" ]; then
            echo "NO_REKOR_UUID_FOUND"
            exit 2
          fi

          FOUND=0
          for u in $UUIDS; do
            curl -fsSL "${REKOR_URL}/api/v1/log/entries/${u}" > "/tmp/rekor_${u}.json"
            jq -r 'to_entries[0].value.body' "/tmp/rekor_${u}.json" | base64 -d > "/tmp/rekor_${u}.body.json"

            DIG="$(jq -r '
              .. | objects
              | ( .spec? // empty )
              | ( .data? // empty )
              | ( .hash? // empty )
              | select(.algorithm?=="sha256")
              | .value? // empty
            ' "/tmp/rekor_${u}.body.json" | head -n1 || true)"

            if [ -n "${DIG:-}" ] && [ "$DIG" != "null" ]; then
              if [ "$DIG" = "$SHA256_LOCAL" ]; then
                FOUND=1
                break
              else
                echo "REKOR_DIGEST_MISMATCH"
                echo "LOCAL=$SHA256_LOCAL"
                echo "REKOR=$DIG"
                exit 3
              fi
            fi
          done

          if [ "$FOUND" -ne 1 ]; then
            echo "REKOR_DIGEST_NOT_EXTRACTED"
            exit 4
          fi

      - name: Upload signed artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fazon-release-${{ github.ref_name }}
          path: |
            dist/release.zip
            dist/release.zip.sha256
            dist/release.zip.sigstore.json
            dist/release.manifest.json

      - name: Create GitHub Release (attach artifacts)
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/release.zip
            dist/release.zip.sha256
            dist/release.zip.sigstore.json
            dist/release.manifest.json
